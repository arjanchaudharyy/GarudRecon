#!/bin/bash

# Light Scan Mode - Fast recon with basic vulnerability checks
# Optimized for speed with essential security checks

CONFIG_PATH="configuration/garudrecon.cfg"
source "$CONFIG_PATH" 2>/dev/null || true

DOMAIN=""
OUTPUT_DIR=""

# Parse arguments
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        -d|--domain)
            DOMAIN="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        *)
            echo "Unknown parameter: $1"
            exit 1
            ;;
    esac
done

# Validate input
if [[ -z "$DOMAIN" ]]; then
    echo "Error: Domain is required (-d)"
    exit 1
fi

if [[ -z "$OUTPUT_DIR" ]]; then
    OUTPUT_DIR="scans/light-$(date +%Y%m%d-%H%M%S)-$DOMAIN"
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Initialize results JSON
RESULTS_FILE="$OUTPUT_DIR/results.json"
echo "{" > "$RESULTS_FILE"
echo "  \"scan_type\": \"light\"," >> "$RESULTS_FILE"
echo "  \"domain\": \"$DOMAIN\"," >> "$RESULTS_FILE"
echo "  \"start_time\": \"$(date -Iseconds)\"," >> "$RESULTS_FILE"
echo "  \"findings\": {" >> "$RESULTS_FILE"

# Logging function
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting LIGHT scan for $DOMAIN"
log "Output directory: $OUTPUT_DIR"

# Step 1: Basic DNS Resolution
log "[1/7] DNS Resolution..."
if command -v dig &> /dev/null; then
    dig +short "$DOMAIN" A | head -5 > "$OUTPUT_DIR/dns_a_records.txt"
    log "Found $(wc -l < "$OUTPUT_DIR/dns_a_records.txt") A records"
fi

# Step 2: Quick Port Scan (common ports only)
log "[2/7] Port Scanning (common ports)..."
if command -v nmap &> /dev/null; then
    nmap -p 21,22,80,443,8080,8443 -T4 --open "$DOMAIN" -oN "$OUTPUT_DIR/ports.txt" &> /dev/null
    OPEN_PORTS=$(grep -c "open" "$OUTPUT_DIR/ports.txt" 2>/dev/null || echo "0")
    log "Found $OPEN_PORTS open ports"
elif command -v naabu &> /dev/null; then
    echo "$DOMAIN" | naabu -p 21,22,80,443,8080,8443 -silent -o "$OUTPUT_DIR/ports.txt" 2>/dev/null
    log "Port scan complete"
fi

# Step 3: HTTP Probing
log "[3/7] HTTP Probing..."
if command -v httpx &> /dev/null; then
    echo "$DOMAIN" | httpx -silent -title -tech-detect -status-code -o "$OUTPUT_DIR/httpx.txt" 2>/dev/null
    log "HTTP probe complete"
fi

# Step 4: Quick URL Discovery
log "[4/7] URL Discovery..."
if command -v waybackurls &> /dev/null; then
    echo "$DOMAIN" | waybackurls 2>/dev/null | head -1000 > "$OUTPUT_DIR/urls.txt"
    log "Found $(wc -l < "$OUTPUT_DIR/urls.txt") URLs"
elif command -v gau &> /dev/null; then
    echo "$DOMAIN" | gau --threads 5 2>/dev/null | head -1000 > "$OUTPUT_DIR/urls.txt"
    log "Found $(wc -l < "$OUTPUT_DIR/urls.txt") URLs"
fi

# Step 5: Quick XSS Check
log "[5/7] XSS Vulnerability Check..."
if [[ -f "$OUTPUT_DIR/urls.txt" ]] && command -v dalfox &> /dev/null; then
    cat "$OUTPUT_DIR/urls.txt" | grep "=" | head -50 | dalfox pipe --silence --no-color -o "$OUTPUT_DIR/xss_findings.txt" 2>/dev/null &
    XSS_PID=$!
else
    log "Skipping XSS check (dalfox not found or no URLs)"
fi

# Step 6: SQL Injection Check
log "[6/7] SQLi Vulnerability Check..."
if [[ -f "$OUTPUT_DIR/urls.txt" ]] && command -v sqlmap &> /dev/null; then
    grep "=" "$OUTPUT_DIR/urls.txt" | head -20 > "$OUTPUT_DIR/urls_with_params.txt"
    if [[ -s "$OUTPUT_DIR/urls_with_params.txt" ]]; then
        log "Testing $(wc -l < "$OUTPUT_DIR/urls_with_params.txt") URLs for SQLi..."
        # Run basic sqlmap check (limited to avoid long scans)
        while IFS= read -r url; do
            timeout 30 sqlmap -u "$url" --batch --level=1 --risk=1 --answers="follow=N" 2>/dev/null | grep -i "parameter.*vulnerable" >> "$OUTPUT_DIR/sqli_findings.txt" 2>/dev/null
        done < "$OUTPUT_DIR/urls_with_params.txt" &
        SQLI_PID=$!
    fi
else
    log "Skipping SQLi check"
fi

# Step 7: Basic Security Headers Check
log "[7/7] Security Headers Check..."
if [[ -f "$OUTPUT_DIR/httpx.txt" ]] && command -v curl &> /dev/null; then
    PROTOCOL=$(grep -oP "https?://" "$OUTPUT_DIR/httpx.txt" | head -1)
    FULL_URL="${PROTOCOL}${DOMAIN}"
    
    curl -sI "$FULL_URL" 2>/dev/null > "$OUTPUT_DIR/headers.txt"
    
    # Check for security headers
    {
        echo "Security Headers Analysis:"
        grep -i "strict-transport-security" "$OUTPUT_DIR/headers.txt" && echo "✓ HSTS Enabled" || echo "✗ HSTS Missing"
        grep -i "x-frame-options" "$OUTPUT_DIR/headers.txt" && echo "✓ X-Frame-Options Set" || echo "✗ X-Frame-Options Missing"
        grep -i "x-content-type-options" "$OUTPUT_DIR/headers.txt" && echo "✓ X-Content-Type-Options Set" || echo "✗ X-Content-Type-Options Missing"
        grep -i "content-security-policy" "$OUTPUT_DIR/headers.txt" && echo "✓ CSP Enabled" || echo "✗ CSP Missing"
    } > "$OUTPUT_DIR/security_headers_analysis.txt"
    
    log "Security headers analyzed"
fi

# Wait for background jobs with timeout
log "Waiting for vulnerability scans to complete..."
[[ -n "$XSS_PID" ]] && timeout 60 wait $XSS_PID 2>/dev/null
[[ -n "$SQLI_PID" ]] && timeout 60 wait $SQLI_PID 2>/dev/null

# Generate Summary
log "Generating summary..."

# Count findings
XSS_COUNT=0
SQLI_COUNT=0
[[ -f "$OUTPUT_DIR/xss_findings.txt" ]] && XSS_COUNT=$(wc -l < "$OUTPUT_DIR/xss_findings.txt")
[[ -f "$OUTPUT_DIR/sqli_findings.txt" ]] && SQLI_COUNT=$(wc -l < "$OUTPUT_DIR/sqli_findings.txt")

# Complete results JSON
cat >> "$RESULTS_FILE" << EOF
    "dns_records": $(wc -l < "$OUTPUT_DIR/dns_a_records.txt" 2>/dev/null || echo "0"),
    "open_ports": $OPEN_PORTS,
    "urls_found": $(wc -l < "$OUTPUT_DIR/urls.txt" 2>/dev/null || echo "0"),
    "xss_findings": $XSS_COUNT,
    "sqli_findings": $SQLI_COUNT
  },
  "end_time": "$(date -Iseconds)",
  "status": "completed"
}
EOF

# Summary
cat > "$OUTPUT_DIR/summary.txt" << EOF
========================================
GarudRecon - LIGHT Scan Summary
========================================
Domain: $DOMAIN
Scan Type: Light (Fast Recon)
Completed: $(date)

FINDINGS:
---------
DNS Records: $(wc -l < "$OUTPUT_DIR/dns_a_records.txt" 2>/dev/null || echo "0")
Open Ports: $OPEN_PORTS
URLs Discovered: $(wc -l < "$OUTPUT_DIR/urls.txt" 2>/dev/null || echo "0")
XSS Findings: $XSS_COUNT
SQLi Findings: $SQLI_COUNT

FILES GENERATED:
---------------
$(ls -1 "$OUTPUT_DIR" | sed 's/^/  - /')

========================================
EOF

cat "$OUTPUT_DIR/summary.txt"
log "Light scan completed successfully!"
log "Results saved to: $OUTPUT_DIR"

exit 0
